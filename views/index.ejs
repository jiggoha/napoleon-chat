<!DOCTYPE html>
<html>
  <head>
    <title>Napoleon</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
  </head>

  <body>
    <p id='cards_label'>Cards:</p>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script>
      helper = require("../client_helper.js");

      var socket = io(); // defaults to connecting to the URL of the 

      $('form').submit(function() {
        var command = $('#m').val();
        var first_two = $('#m').val().split(" ").splice(0,2).join(" ");
        var arg = $('#m').val().split(" ")[2];

        if ($('#m').val() == '\\start game') {
          socket.emit('start game');
        } else if (first_two == '\\declare napoleon') {
          socket.emit('declare napoleon', arg);
        } else if (first_two == '\\declare trump') {
          socket.emit('declare trump', arg);
        } else if (first_two == '\\declare secretary') {
          socket.emit('declare secretary', arg);
        } else if (first_two == '\\declare bid') {
          socket.emit('declare bid', arg);
        }
        
        socket.emit('chat message', $('#m').val());

        $('#m').val('');
        socket.emit('not typing', socket.username);
        return false;
      });

      $('#m').keyup(function() {
        if (($('#m').val() != '') && !($('#' + socket.username + '_is_typing').text())) {
          socket.emit('is typing', socket.username);
        }
      });

      socket.on('display typing', function(username) {
        $('#messages').after($("<div id='" + username + "_is_typing'>").text(username + " is typing..."))
      });

      socket.on('remove typing', function(username) {
        $("#"+ username + "_is_typing").remove();
      });

      socket.on('show users', function(usernames){
        if ($('#user_list')[0]) {
          $('#user_list').text("In this room: " + usernames.join(", "));
        } else {
          $('#messages').before($("<div id='user_list'>").text("In this room: " + usernames.join(", ")));
        }
      });

      socket.on('load previous messages', function(messages) {
        for (i = 0; i < messages.length; i++) {
          display_message(messages[i]);
        }
      });

      socket.on('prompt username', function(username) {
        var username = prompt("What is your name?");

        while (username == '') {
          username = prompt("No, seriously, what is your name?");
        }

        socket.username = username;
        socket.emit('add username', username);
      });

      socket.on('announce new user', function(username) {
        display_message(username + " joined");
      });
      
      socket.on('chat message', function(username, msg) {
        display_message(username + ": " + msg);
      });

      socket.on('user disconnected', function(username) {
        display_message(username + " left");
      });

      // initial deal
      socket.on('first deal', function() {
        socket.emit('ask for cards', socket.username);
      });
      socket.on('receive cards', function(cards) {
        for (var i=0; i<cards.length; i++) {
          if (cards[i].suit == "spades" || cards[i].suit == "clubs") {
            $('#cards_label').after($('<p id=' + cards[i].value + ' class="black card">' + cards[i].value + '</p>'));
          } else {
            $('#cards_label').after($('<p id=' + cards[i].value + ' class="red card">' + cards[i].value + '</p>'));
          }
        }
      });

      // turn verification
      socket.on('not your turn', function(whose_turn) {
        alert("It's not your turn to play a card. Wait for " + whose_turn + " to move.")
      });
      socket.on('remove card', function(card_value) {
        $('#' + card_value).remove();
      });

      // trigger verification of whether you can play
      $('body').on('click', '.card', function() {
        socket.emit('play card', socket.username, $(this).text());
      });

      function display_message(text) {
        var last_message = $('#messages li:last').text()

        if (last_message.split(" ")[0] == text.split(" ")[0]) {
          $('#messages li:last').append($('<br>'));
          $('#messages li:last').append(text);
        } else {
          $('#messages').append($('<li>').text(text));
        }
      }
    </script>
  </body>

</html>